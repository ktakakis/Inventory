@model netcore.Models.Invent.SalesOrder

@{
    ViewData["Title"] = "Λεπτομέρειες";
    Layout = "~/Views/Shared/_AdminlteNetcoreDetails.cshtml";
    ViewData["EntityIcon"] = "fa fa-cart-plus";

}
    <div class="row">
        <div class="col-md-9">
            <!-- Default box -->
            <div class="box box-primary">
                <div class="box-body">
                    <div class="row">
                        <div class="col-md-12">
                            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                            <input type="hidden" asp-for="salesOrderId" />
                            <input type="hidden" asp-for="salesOrderNumber" />
                            <input type="hidden" asp-for="salesOrderStatus" />
                            <div class="row">
                                <div class="col-md-12">
                                    <small class="text-yellow"><i>Περίληψη</i></small>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="salesOrderNumber" class="control-label"></label>
                                        <input disabled asp-for="salesOrderNumber" class="form-control" />
                                        <span asp-validation-for="salesOrderNumber" class="text-danger"></span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="salesOrderStatus" class="control-label"></label>
                                        <select disabled asp-for="salesOrderStatus" class="form-control select2" asp-items="Html.GetEnumSelectList<netcore.Models.Invent.SalesOrderStatus>()" role="combobox"></select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="customerId" class="control-label">Πελάτης</label>
                                        <select disabled asp-for="customerId" id="customerList" class="form-control select2" asp-items="ViewBag.customerId" role="combobox"></select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="customerLineId" class="control-label">Διεύθυνση</label>
                                        <select disabled asp-for="customerLineId" id="customerLineList" class="form-control select2" asp-items="ViewBag.customerLineId" role="combobox"></select>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label asp-for="description" class="control-label"></label>
                                <textarea disabled asp-for="description" class="form-control" rows="3"></textarea>
                                <span asp-validation-for="description" class="text-danger"></span>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="soDate" class="control-label"></label>
                                        <div class="input-group date">
                                            <div class="input-group-addon">
                                                <i class="fa fa-calendar"></i>
                                            </div>
                                            <input disabled asp-for="soDate" value="@Model.soDate.ToString("dd/MM/yyyy")" class="form-control pull-right datepicker" type="text" />
                                        </div>
                                        <span asp-validation-for="soDate" class="text-danger"></span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="deliveryDate" class="control-label"></label>
                                        <div class="input-group date">
                                            <div class="input-group-addon">
                                                <i class="fa fa-calendar"></i>
                                            </div>
                                            <input disabled asp-for="deliveryDate" value="@Model.deliveryDate.ToString("dd/MM/yyyy")" class="form-control pull-right datepicker" type="text" />
                                        </div>
                                        <span asp-validation-for="deliveryDate" class="text-danger"></span>
                                    </div>
                                </div>

                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="branchId" class="control-label">Υποκατάστημα</label>
                                        <select disabled asp-for="branchId" class="form-control select2" asp-items="ViewBag.branchId" role="combobox"></select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="top" class="control-label">Τρόπος Πληρωμής</label>
                                        <select disabled asp-for="top" class="form-control select2" asp-items="Html.GetEnumSelectList<netcore.Models.Invent.TOP>()" role="combobox"></select>
                                    </div>
                                </div>

                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group has-success">
                                        <label asp-for="EmployeeId" class="control-label">Συνεργάτης</label>
                                        <select disabled asp-for="EmployeeId" class="form-control select2" asp-items="ViewBag.employeeId"></select>
                                        <span asp-validation-for="EmployeeId" class="text-danger"></span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="Invoicing" class="control-label"></label>
                                        <input disabled type="checkbox" asp-for="Invoicing" class="checkbox" />
                                        <span asp-validation-for="Invoicing" class="text-danger"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label asp-for="totalDiscountAmount" class="control-label"></label>
                                        <input disabled asp-for="totalDiscountAmount" class="form-control" />
                                        <span asp-validation-for="totalDiscountAmount" class="text-danger"></span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label asp-for="totalOrderAmount" class="control-label"></label>
                                        <input disabled asp-for="totalOrderAmount" class="form-control" />
                                        <span asp-validation-for="totalOrderAmount" class="text-danger"></span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label asp-for="TotalProductVAT" class="control-label"></label>
                                        <input disabled asp-for="TotalProductVAT" class="form-control" />
                                        <span asp-validation-for="TotalProductVAT" class="text-danger"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group hidden">
                                <label asp-for="salesShipmentNumber" class="control-label"></label>
                                <input disabled asp-for="salesShipmentNumber" class="form-control" />
                                <span asp-validation-for="salesShipmentNumber" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                    <!-- /.box-body -->
                    <div class="box-footer">
                        <div class="form-group">
                            <a asp-action="Edit" asp-route-id="@Model.salesOrderId" class="btn btn-primary">Επεξεργασία</a>
                            <a asp-action="ShowSalesOrder" asp-route-id="@Model.salesOrderId" class="btn btn-primary pull-right"><i class="fa fa-print"></i> Εκτύπωση Παραγγελίας</a>
                            <a asp-action="Index" class="btn btn-default">Επιστροφή στη λίστα</a>
                            <a asp-action="Create" asp-controller="Shipment" asp-route-Id="@Model.salesOrderId" class="btn btn-primary"><i class="fa fa-plane"></i>Δημιουργία Αποστολής</a>
                        </div>
                    </div>
                    <!-- /.box-footer-->
                </div>
                <!-- /.box -->
            </div>
        </div>
        <div class="col-md-3">
            @await Html.PartialAsync("~/Views/Shared/_AdminlteNetcoreTimeline.cshtml")
        </div>
    </div>

<!--Products Child-->
<div class="row">
    <div class="col-md-9">
        <!-- Default box -->
        <div class="box box-primary">

            <div class="box-body">
                <div class="row">
                    <div class="col-md-12 table-responsive">
                        <table id="grid" name="grid" class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th class="col-md-4">Προϊόν</th>
                                    <th class="col-md-4">Ποσ</th>
                                    <th class="col-md-3">Τιμή</th>
                                    <th class="col-md-1"></th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
            <!-- /.box-body -->
            <div class="box-footer">
                <div class="form-group">
                    <div class="row">
                        <div class="col-md-12">
                            <a class="btn btn-success" style="margin-bottom:10px" onclick="ShowPopup('@Url.Action("Create","SalesOrderLine", new { masterid = Model.salesOrderId })')"><i class="fa fa-plus"></i> Προσθήκη Προϊόντος</a>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /.box-footer-->
        </div>
        <!-- /.box -->
    </div>
    <div class="col-md-3">
    </div>
</div>



<!--modal placeholder-->
<div class="modal modal-primary fade" id="modalDefault">
    <div class="modal-dialog">
        <div class="modal-content">
        </div>
    </div>
</div>
@section Scripts {

    <script>
        var popup, dataTable;
        var entity = 'SalesOrderLine';
        var apiurl = '/api/' + entity;

        $(document).ready(function () {
            dataTable = $('#grid').DataTable({
                        "language": {
                            "url": '..\\..\\locale\\DataTable-GR.json'
                 },
                "ajax": {
                    "url": apiurl + '?masterid=@Model.salesOrderId',
                    "type": 'GET',
                    "datatype": 'json'
                },
                "columns": [
                    { "data": "product.productCode" },
                    { "data": "qty" },
                    {
                        "data": "price",
                        render: $.fn.dataTable.render.number( '.', ',', 2, '€' )
                    },
                    {
                        "data": "salesOrderLineId",
                        "render": function (data) {
                            var btnEdit = "<a class='btn btn-primary btn-xs' onclick=ShowPopup('/" + entity + "/Create/" + data + "')><i class='fa fa-pencil'></i></a>";
                            var btnDelete = "<a class='btn btn-danger btn-xs' style='margin-left:2px' onclick=Delete('" + data + "')><i class='fa fa-trash'></i></a>";

                            return "<div class='tools pull-right'>" + btnEdit + btnDelete + "</div>";
                        }
                    }
                ],
                "lengthChange": false,
                "info": false,
                "searching": false,
                "paging": false,
            });
        });

        function ShowPopup(url) {
            var modalId = 'modalDefault';
            var modalPlaceholder = $('#' + modalId + ' .modal-dialog .modal-content');
            $.get(url)
                .done(function (response) {
                    modalPlaceholder.html(response);
                    popup = $('#' + modalId + '').modal({
                        keyboard: false,
                        backdrop: 'static'
                    });
                });
        }

        function SubmitAddEdit(form) {
            $.validator.unobtrusive.parse(form);
            if ($(form).valid()) {
                var data = $(form).serializeJSON();
                data['DiscountAmount']=parseFloat(data['DiscountAmount'].toString().replace(',', '.'));
                data['Price']=data['Price'].toString().replace( ',', '.');
                data['TotalAmount']=data['TotalAmount'].toString().replace(',', '.');
                data['ProductVAT']=data['ProductVAT'].toString().replace(',', '.');
                data['Discount'] = data['Discount'].toString().replace(',', '.');
                data['ProductVATAmount'] = data['ProductVATAmount'].toString().replace(',', '.');
                data['SpecialTaxAmount']=data['SpecialTaxAmount'].toString().replace(',', '.');
                data['UnitCost'] = data['UnitCost'].toString().replace(',', '.');
                data['SpecialTaxDiscount'] = data['SpecialTaxDiscount'].toString().replace(',', '.');
                data['TotalBeforeDiscount'] = data['TotalBeforeDiscount'].toString().replace(',', '.');
                data['TotalAfterDiscount'] = data['TotalAfterDiscount'].toString().replace(',', '.');
                data['TotalSpecialTaxAmount'] = data['TotalSpecialTaxAmount'].toString().replace(',', '.');
                data['TotalWithSpecialTax'] = data['TotalWithSpecialTax'].toString().replace(',', '.');

                data = JSON.stringify(data);
                $.ajax({
                    type: 'POST',
                    url: apiurl,
                    data: data,
                    contentType: 'application/json',
                    success: function (data) {
                        if (data.success) {
                            popup.modal('hide');
                            ShowMessage(data.message);
                            dataTable.ajax.reload();
                        } else {
                            popup.modal('hide');
                            ShowMessageError(data.message);
                            dataTable.ajax.reload();
                        }
                    }
                });

            }
            return false;
        }

        function Delete(id) {
            swal({
                title: "Είστε βέβαιοι ότι θέλετε να γίνει Διαγραφή;",
                text: "Δεν θα μπορείτε να επαναφέρετε τα δεδομένα!",
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#dd4b39",
                confirmButtonText: "Ναι, διαγράψτε το!",
                closeOnConfirm: true
            }, function () {
                $.ajax({
                    type: 'DELETE',
                    url: apiurl + '/' + id,
                    success: function (data) {
                        if (data.success) {
                            ShowMessage(data.message);
                            dataTable.ajax.reload();
                        } else {
                            ShowMessageError(data.message);
                            dataTable.ajax.reload();
                        }
                    }
                });
            });


        }

        //Bind customerLine dropdownlist
        $("#customerList").change(function () {
            var customerId = $("#customerList").val();
            var url = "/SalesOrder/GetCustomerLines";

            $.getJSON(url, { customerId: customerId }, function (data) {
                var item = "";
                $("#customerLineList").empty();
                $.each(data, function (i, customerLine) {
                    item += '<option value="' + customerLine.value + '">' + customerLine.text + '</option>'
                });
                $("#customerLineList").html(item);
            });
        });

    </script>
}